const rotorsTemplate = [
    [
        {"precodedLetter" : "A", "encodedLetter" : "D", "currentIndex" : 0},
        {"precodedLetter" : "B", "encodedLetter" : "M", "currentIndex" : 1},
        {"precodedLetter" : "C", "encodedLetter" : "T", "currentIndex" : 2},
        {"precodedLetter" : "D", "encodedLetter" : "W", "currentIndex" : 3},
        {"precodedLetter" : "E", "encodedLetter" : "S", "currentIndex" : 4},
        {"precodedLetter" : "F", "encodedLetter" : "I", "currentIndex" : 5},
        {"precodedLetter" : "G", "encodedLetter" : "L", "currentIndex" : 6},
        {"precodedLetter" : "H", "encodedLetter" : "R", "currentIndex" : 7},
        {"precodedLetter" : "I", "encodedLetter" : "U", "currentIndex" : 8},
        {"precodedLetter" : "J", "encodedLetter" : "Y", "currentIndex" : 9},
        {"precodedLetter" : "K", "encodedLetter" : "Q", "currentIndex" : 10},
        {"precodedLetter" : "L", "encodedLetter" : "N", "currentIndex" : 11},
        {"precodedLetter" : "M", "encodedLetter" : "K", "currentIndex" : 12},
        {"precodedLetter" : "N", "encodedLetter" : "F", "currentIndex" : 13},
        {"precodedLetter" : "O", "encodedLetter" : "E", "currentIndex" : 14},
        {"precodedLetter" : "P", "encodedLetter" : "J", "currentIndex" : 15},
        {"precodedLetter" : "Q", "encodedLetter" : "C", "currentIndex" : 16},
        {"precodedLetter" : "R", "encodedLetter" : "A", "currentIndex" : 17},
        {"precodedLetter" : "S", "encodedLetter" : "Z", "currentIndex" : 18},
        {"precodedLetter" : "T", "encodedLetter" : "B", "currentIndex" : 19},
        {"precodedLetter" : "U", "encodedLetter" : "P", "currentIndex" : 20},
        {"precodedLetter" : "V", "encodedLetter" : "G", "currentIndex" : 21},
        {"precodedLetter" : "W", "encodedLetter" : "X", "currentIndex" : 22},
        {"precodedLetter" : "X", "encodedLetter" : "O", "currentIndex" : 23},
        {"precodedLetter" : "Y", "encodedLetter" : "H", "currentIndex" : 24},
        {"precodedLetter" : "Z", "encodedLetter" : "V", "currentIndex" : 25},
    ],
    [
        {"precodedLetter" : "A", "encodedLetter" : "H", "currentIndex" : 0},
        {"precodedLetter" : "B", "encodedLetter" : "Q", "currentIndex" : 1},
        {"precodedLetter" : "C", "encodedLetter" : "Z", "currentIndex" : 2},
        {"precodedLetter" : "D", "encodedLetter" : "G", "currentIndex" : 3},
        {"precodedLetter" : "E", "encodedLetter" : "P", "currentIndex" : 4},
        {"precodedLetter" : "F", "encodedLetter" : "J", "currentIndex" : 5},
        {"precodedLetter" : "G", "encodedLetter" : "T", "currentIndex" : 6},
        {"precodedLetter" : "H", "encodedLetter" : "M", "currentIndex" : 7},
        {"precodedLetter" : "I", "encodedLetter" : "O", "currentIndex" : 8},
        {"precodedLetter" : "J", "encodedLetter" : "B", "currentIndex" : 9},
        {"precodedLetter" : "K", "encodedLetter" : "L", "currentIndex" : 10},
        {"precodedLetter" : "L", "encodedLetter" : "N", "currentIndex" : 11},
        {"precodedLetter" : "M", "encodedLetter" : "C", "currentIndex" : 12},
        {"precodedLetter" : "N", "encodedLetter" : "I", "currentIndex" : 13},
        {"precodedLetter" : "O", "encodedLetter" : "F", "currentIndex" : 14},
        {"precodedLetter" : "P", "encodedLetter" : "D", "currentIndex" : 15},
        {"precodedLetter" : "Q", "encodedLetter" : "Y", "currentIndex" : 16},
        {"precodedLetter" : "R", "encodedLetter" : "A", "currentIndex" : 17},
        {"precodedLetter" : "S", "encodedLetter" : "W", "currentIndex" : 18},
        {"precodedLetter" : "T", "encodedLetter" : "V", "currentIndex" : 19},
        {"precodedLetter" : "U", "encodedLetter" : "E", "currentIndex" : 20},
        {"precodedLetter" : "V", "encodedLetter" : "U", "currentIndex" : 21},
        {"precodedLetter" : "W", "encodedLetter" : "S", "currentIndex" : 22},
        {"precodedLetter" : "X", "encodedLetter" : "R", "currentIndex" : 23},
        {"precodedLetter" : "Y", "encodedLetter" : "K", "currentIndex" : 24},
        {"precodedLetter" : "Z", "encodedLetter" : "X", "currentIndex" : 25},
    ],
    [
        {"precodedLetter" : "A", "encodedLetter" : "U", "currentIndex" : 0},
        {"precodedLetter" : "B", "encodedLetter" : "Q", "currentIndex" : 1},
        {"precodedLetter" : "C", "encodedLetter" : "N", "currentIndex" : 2},
        {"precodedLetter" : "D", "encodedLetter" : "T", "currentIndex" : 3},
        {"precodedLetter" : "E", "encodedLetter" : "L", "currentIndex" : 4},
        {"precodedLetter" : "F", "encodedLetter" : "S", "currentIndex" : 5},
        {"precodedLetter" : "G", "encodedLetter" : "Z", "currentIndex" : 6},
        {"precodedLetter" : "H", "encodedLetter" : "F", "currentIndex" : 7},
        {"precodedLetter" : "I", "encodedLetter" : "M", "currentIndex" : 8},
        {"precodedLetter" : "J", "encodedLetter" : "R", "currentIndex" : 9},
        {"precodedLetter" : "K", "encodedLetter" : "E", "currentIndex" : 10},
        {"precodedLetter" : "L", "encodedLetter" : "H", "currentIndex" : 11},
        {"precodedLetter" : "M", "encodedLetter" : "D", "currentIndex" : 12},
        {"precodedLetter" : "N", "encodedLetter" : "P", "currentIndex" : 13},
        {"precodedLetter" : "O", "encodedLetter" : "X", "currentIndex" : 14},
        {"precodedLetter" : "P", "encodedLetter" : "K", "currentIndex" : 15},
        {"precodedLetter" : "Q", "encodedLetter" : "I", "currentIndex" : 16},
        {"precodedLetter" : "R", "encodedLetter" : "B", "currentIndex" : 17},
        {"precodedLetter" : "S", "encodedLetter" : "V", "currentIndex" : 18},
        {"precodedLetter" : "T", "encodedLetter" : "Y", "currentIndex" : 19},
        {"precodedLetter" : "U", "encodedLetter" : "G", "currentIndex" : 20},
        {"precodedLetter" : "V", "encodedLetter" : "J", "currentIndex" : 21},
        {"precodedLetter" : "W", "encodedLetter" : "C", "currentIndex" : 22},
        {"precodedLetter" : "X", "encodedLetter" : "W", "currentIndex" : 23},
        {"precodedLetter" : "Y", "encodedLetter" : "O", "currentIndex" : 24},
        {"precodedLetter" : "Z", "encodedLetter" : "A", "currentIndex" : 25},
    ]
];
let rotors = [
    [
        {"precodedLetter" : "A", "encodedLetter" : "D", "currentIndex" : 0},
        {"precodedLetter" : "B", "encodedLetter" : "M", "currentIndex" : 1},
        {"precodedLetter" : "C", "encodedLetter" : "T", "currentIndex" : 2},
        {"precodedLetter" : "D", "encodedLetter" : "W", "currentIndex" : 3},
        {"precodedLetter" : "E", "encodedLetter" : "S", "currentIndex" : 4},
        {"precodedLetter" : "F", "encodedLetter" : "I", "currentIndex" : 5},
        {"precodedLetter" : "G", "encodedLetter" : "L", "currentIndex" : 6},
        {"precodedLetter" : "H", "encodedLetter" : "R", "currentIndex" : 7},
        {"precodedLetter" : "I", "encodedLetter" : "U", "currentIndex" : 8},
        {"precodedLetter" : "J", "encodedLetter" : "Y", "currentIndex" : 9},
        {"precodedLetter" : "K", "encodedLetter" : "Q", "currentIndex" : 10},
        {"precodedLetter" : "L", "encodedLetter" : "N", "currentIndex" : 11},
        {"precodedLetter" : "M", "encodedLetter" : "K", "currentIndex" : 12},
        {"precodedLetter" : "N", "encodedLetter" : "F", "currentIndex" : 13},
        {"precodedLetter" : "O", "encodedLetter" : "E", "currentIndex" : 14},
        {"precodedLetter" : "P", "encodedLetter" : "J", "currentIndex" : 15},
        {"precodedLetter" : "Q", "encodedLetter" : "C", "currentIndex" : 16},
        {"precodedLetter" : "R", "encodedLetter" : "A", "currentIndex" : 17},
        {"precodedLetter" : "S", "encodedLetter" : "Z", "currentIndex" : 18},
        {"precodedLetter" : "T", "encodedLetter" : "B", "currentIndex" : 19},
        {"precodedLetter" : "U", "encodedLetter" : "P", "currentIndex" : 20},
        {"precodedLetter" : "V", "encodedLetter" : "G", "currentIndex" : 21},
        {"precodedLetter" : "W", "encodedLetter" : "X", "currentIndex" : 22},
        {"precodedLetter" : "X", "encodedLetter" : "O", "currentIndex" : 23},
        {"precodedLetter" : "Y", "encodedLetter" : "H", "currentIndex" : 24},
        {"precodedLetter" : "Z", "encodedLetter" : "V", "currentIndex" : 25},
    ],
    [
        {"precodedLetter" : "A", "encodedLetter" : "H", "currentIndex" : 0},
        {"precodedLetter" : "B", "encodedLetter" : "Q", "currentIndex" : 1},
        {"precodedLetter" : "C", "encodedLetter" : "Z", "currentIndex" : 2},
        {"precodedLetter" : "D", "encodedLetter" : "G", "currentIndex" : 3},
        {"precodedLetter" : "E", "encodedLetter" : "P", "currentIndex" : 4},
        {"precodedLetter" : "F", "encodedLetter" : "J", "currentIndex" : 5},
        {"precodedLetter" : "G", "encodedLetter" : "T", "currentIndex" : 6},
        {"precodedLetter" : "H", "encodedLetter" : "M", "currentIndex" : 7},
        {"precodedLetter" : "I", "encodedLetter" : "O", "currentIndex" : 8},
        {"precodedLetter" : "J", "encodedLetter" : "B", "currentIndex" : 9},
        {"precodedLetter" : "K", "encodedLetter" : "L", "currentIndex" : 10},
        {"precodedLetter" : "L", "encodedLetter" : "N", "currentIndex" : 11},
        {"precodedLetter" : "M", "encodedLetter" : "C", "currentIndex" : 12},
        {"precodedLetter" : "N", "encodedLetter" : "I", "currentIndex" : 13},
        {"precodedLetter" : "O", "encodedLetter" : "F", "currentIndex" : 14},
        {"precodedLetter" : "P", "encodedLetter" : "D", "currentIndex" : 15},
        {"precodedLetter" : "Q", "encodedLetter" : "Y", "currentIndex" : 16},
        {"precodedLetter" : "R", "encodedLetter" : "A", "currentIndex" : 17},
        {"precodedLetter" : "S", "encodedLetter" : "W", "currentIndex" : 18},
        {"precodedLetter" : "T", "encodedLetter" : "V", "currentIndex" : 19},
        {"precodedLetter" : "U", "encodedLetter" : "E", "currentIndex" : 20},
        {"precodedLetter" : "V", "encodedLetter" : "U", "currentIndex" : 21},
        {"precodedLetter" : "W", "encodedLetter" : "S", "currentIndex" : 22},
        {"precodedLetter" : "X", "encodedLetter" : "R", "currentIndex" : 23},
        {"precodedLetter" : "Y", "encodedLetter" : "K", "currentIndex" : 24},
        {"precodedLetter" : "Z", "encodedLetter" : "X", "currentIndex" : 25},
    ],
    [
        {"precodedLetter" : "A", "encodedLetter" : "U", "currentIndex" : 0},
        {"precodedLetter" : "B", "encodedLetter" : "Q", "currentIndex" : 1},
        {"precodedLetter" : "C", "encodedLetter" : "N", "currentIndex" : 2},
        {"precodedLetter" : "D", "encodedLetter" : "T", "currentIndex" : 3},
        {"precodedLetter" : "E", "encodedLetter" : "L", "currentIndex" : 4},
        {"precodedLetter" : "F", "encodedLetter" : "S", "currentIndex" : 5},
        {"precodedLetter" : "G", "encodedLetter" : "Z", "currentIndex" : 6},
        {"precodedLetter" : "H", "encodedLetter" : "F", "currentIndex" : 7},
        {"precodedLetter" : "I", "encodedLetter" : "M", "currentIndex" : 8},
        {"precodedLetter" : "J", "encodedLetter" : "R", "currentIndex" : 9},
        {"precodedLetter" : "K", "encodedLetter" : "E", "currentIndex" : 10},
        {"precodedLetter" : "L", "encodedLetter" : "H", "currentIndex" : 11},
        {"precodedLetter" : "M", "encodedLetter" : "D", "currentIndex" : 12},
        {"precodedLetter" : "N", "encodedLetter" : "P", "currentIndex" : 13},
        {"precodedLetter" : "O", "encodedLetter" : "X", "currentIndex" : 14},
        {"precodedLetter" : "P", "encodedLetter" : "K", "currentIndex" : 15},
        {"precodedLetter" : "Q", "encodedLetter" : "I", "currentIndex" : 16},
        {"precodedLetter" : "R", "encodedLetter" : "B", "currentIndex" : 17},
        {"precodedLetter" : "S", "encodedLetter" : "V", "currentIndex" : 18},
        {"precodedLetter" : "T", "encodedLetter" : "Y", "currentIndex" : 19},
        {"precodedLetter" : "U", "encodedLetter" : "G", "currentIndex" : 20},
        {"precodedLetter" : "V", "encodedLetter" : "J", "currentIndex" : 21},
        {"precodedLetter" : "W", "encodedLetter" : "C", "currentIndex" : 22},
        {"precodedLetter" : "X", "encodedLetter" : "W", "currentIndex" : 23},
        {"precodedLetter" : "Y", "encodedLetter" : "O", "currentIndex" : 24},
        {"precodedLetter" : "Z", "encodedLetter" : "A", "currentIndex" : 25},
    ]
];
let rotorsCounter = new Array(rotors.length);


function encodeLetterViaRotor(rotorId, letter) {
    const currentRotor = rotors[rotorId];
    const encodedLetter = currentRotor.filter(l => l.precodedLetter === letter);
    return encodedLetter[0]["encodedLetter"];
}
function decodeLetterViaRotor(rotorId, letter) {
    const currentRotor = rotors[rotorId];
    const decodedLetter = currentRotor.filter(l => l.encodedLetter === letter);
    return decodedLetter[0]["precodedLetter"];
}

function resetRotorsCounter() {
    for (let i = 0; i < rotorsCounter.length; i++) {
        rotorsCounter[i] = 0;
    }
}

function changeRotorsAssignment(rotorId, direction) {
    let newRotor = rotors[rotorId];
    if (direction === "forward") {
        const tmpEncodedLetter = newRotor[newRotor.length - 1]["encodedLetter"];
        const tmpLetterIndex = newRotor[newRotor.length - 1]["currentIndex"];
        for (let i = newRotor.length - 1; i > 0; i--) {
            newRotor[i]["encodedLetter"] = newRotor[i - 1]["encodedLetter"];
            newRotor[i]["currentIndex"] = newRotor[i - 1]["currentIndex"];
        }
        newRotor[0]["encodedLetter"] = tmpEncodedLetter;
        newRotor[0]["currentIndex"] = tmpLetterIndex;
    }
    if (direction === "back") {
        const tmpEncodedLetter = newRotor[0]["encodedLetter"];
        const tmpLetterIndex = newRotor[0]["currentIndex"];
        for (let i = 0 ; i < newRotor.length - 1; i++) {
            newRotor[i]["encodedLetter"] = newRotor[i + 1]["encodedLetter"];
            newRotor[i]["currentIndex"] = newRotor[i + 1]["currentIndex"];
        }
        newRotor[newRotor.length - 1]["encodedLetter"] = tmpEncodedLetter;
        newRotor[newRotor.length - 1]["currentIndex"] = tmpLetterIndex;
    }
    rotors[rotorId] = newRotor;
}

function resetRotors() {
    rotors = JSON.parse(JSON.stringify( rotorsTemplate ));
    resetRotorsCounter();
    updateRotorsSequence();
}

function rotateRotors(direction) {
    changeRotorsAssignment(0, direction);
    rotorsCounter[0]++;
    for (let i = 0; i < rotors.length; i++){
        if (rotorsCounter[i] >= keyCodes.length) {
            rotorsCounter[i+1]++;
            rotorsCounter[i] = 0;
            if (i+1 < rotors.length) {
                changeRotorsAssignment(i+1, direction);
            }
        }
    }
}

function generateRotorSequence(rotorId) {
    let rotorString = "";
    for (let i = 0; i < rotors[rotorId].length; i++) {
        rotorString += rotors[rotorId][i]["encodedLetter"];
    }
    return rotorString;
}

function generateRotorsTableRows() {
    for (let i = 0; i < rotors.length; i++) {
        var rotorChangeButtonFront = document.createElement("BUTTON");
        rotorChangeButtonFront.classList.add("rotor-button");
        rotorChangeButtonFront.innerHTML = "&#8656;";
        rotorChangeButtonFront.onclick = function() {
            changeRotorsAssignment(i, "back");
            updateRotorCounter(i, 1);
            updateRotorsSequence();
        };
        var rotorChangeButtonEnd = document.createElement("BUTTON");

        rotorChangeButtonEnd.classList.add("rotor-button");
        rotorChangeButtonEnd.innerHTML = "&#8658;";
        rotorChangeButtonEnd.onclick = function () {
            changeRotorsAssignment(i, "forward");
            updateRotorCounter(i, -1);
            updateRotorsSequence();
        };

        var headCell = document.createElement("TD");
        headCell.id = "rotor-head-cell-" + i;
        headCell.innerText = "Rotor #" + i;

        var sequenceSpan = document.createElement("SPAN");
        sequenceSpan.id = "rotor-sequence-span-" + i;
        sequenceSpan.innerText = generateRotorSequence(i);

        var sequenceCell = document.createElement("TD");
        sequenceCell.appendChild(rotorChangeButtonFront);
        sequenceCell.id = "rotor-sequence-cell-" + i;
        sequenceCell.appendChild(sequenceSpan);
        sequenceCell.appendChild(rotorChangeButtonEnd);

        var newRow = document.createElement("TR");
        newRow.id = "rotor-" + i;
        newRow.appendChild(headCell);
        newRow.appendChild(sequenceCell);
        $("#rotorsValues").append(newRow);
    }
}

function updateRotorsSequence() {
    for (let i = 0; i < rotors.length; i++) {
        const cellId = "#rotor-sequence-span-" + i;
        $(cellId).text(generateRotorSequence(i));
    }
}

function translatePatternToRotorsShift(rotorsValues) {
    let newValues = [];
    for (let i = 0; i < rotorsValues.length; i++) {
        newValues.push(parseInt(rotorsValues[i]));
    }
    return newValues;
}

function adjustRotors(rotorsValues) {
    for (let i = 0; i < rotorsValues.length; i++) {
        rotorsCounter[i] = rotorsValues[i];
        for (let j = 0; j < rotorsValues[i]; j++) {
            changeRotorsAssignment(i, "back");
        }
    }
    updateRotorsSequence();
}

function printRotorsFromArray() {
    console.log(rotors);
}

function printRotors(rotorId) {
    for (let i = 0; i < 26; i++) {
        var tmp = '{"precodedLetter" : "' + keyCodes[i]["letter"] +
            '", "encodedLetter" : "' + rotors[rotorId][i]["encodedLetter"] +
            '", "currentIndex" : ' + i + '}, ';
        console.log(tmp);
    }
}

function updateRotorCounter(rotorId, direction) {
    rotorsCounter[rotorId] += direction;
    if(rotorsCounter[rotorId] === -1) {
        rotorsCounter[rotorId] = 25;
    }
    if(rotorsCounter[rotorId] === 26) {
        rotorsCounter[rotorId] = 0;
    }
}